<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>LOGICODERS - Estado del Envío</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Favicon -->
  <link href="img/logo.png" rel="icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

  <!-- Bootstrap -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link href="css/style.css" rel="stylesheet">

  <style>
    :root{
      --brand:#ff5a18; --brand-2:#ff7b39; --ink:#1f2937; --muted:#6b7280; --line:#e5e7eb;
      --ok:#16a34a;
    }
    body{font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;color:var(--ink)}
    .topbar{background:#0b0f1a}
    .btn-brand{background:var(--brand);border:none}
    .btn-brand:hover{background:var(--brand-2)}
    .track-hero{padding:88px 0 72px;background:#f9fafb}
    .track-box{max-width:900px;margin:auto;background:#fff;border-radius:18px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:20px;background:#f3f4f6;cursor:pointer}
    .chip:hover{background:#fff}

    /* Result */
    .result-card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 6px 22px rgba(0,0,0,.06)}
    .result-header{display:flex;align-items:center;gap:14px}
    .result-header .state-icon{
      width:42px;height:42px;display:flex;align-items:center;justify-content:center;
      border:2px solid var(--brand);border-radius:999px;color:var(--brand);
    }
    .result-header h3{margin:0;font-weight:800;letter-spacing:.02em;color:var(--brand)}
    .guide-num{color:#9ca3af;font-size:.9rem}

    /* Tabs */
    .tabs{display:flex;gap:12px;margin-top:14px}
    .tab-btn{
      border:1px solid #ffd3c1;background:#fff;border-radius:10px;padding:8px 14px;font-weight:700;
      color:#a2411a; letter-spacing:.06em; cursor:pointer; transition:all .2s;
    }
    .tab-btn:hover{background:#fff6f1}
    .tab-btn.active{background:var(--brand);border-color:var(--brand);color:#fff;box-shadow:0 6px 18px rgba(255,90,24,.25)}

    /* Stepper (naranja) */
    .progress-track{position:relative;margin:22px 0 6px}
    .progress-line{position:absolute;left:0;right:0;top:14px;height:2px;background:#000713}
    .progress-fill{position:absolute;left:0;top:14px;height:2px;background:var(--brand);width:var(--fill,0%);transition:width .4s ease}
    .progress-steps{display:flex;justify-content:space-between;align-items:center}
    .progress-node{z-index:1;width:28px;height:28px;border-radius:999px;background:#ffe8de;color:#a2411a;
      display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.95rem;border:1px solid #ffc2a8}
    .progress-node.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .progress-labels{display:flex;justify-content:space-between;margin-top:8px;font-size:.78rem;letter-spacing:.08em}
    .progress-labels span{width:25%;text-align:center;color:#374151;font-weight:600}

    /* Panels */
    .panel{display:none;margin-top:16px}
    .panel.active{display:block}
    .section-title{font-weight:700;margin:10px 0 8px}
    .divider{height:1px;background:#eee;margin:14px 0}

    .kv{display:flex;gap:8px;align-items:center;margin-bottom:6px}
    .kv .k{color:#6b7280;min-width:160px}
    .badge-soft{background:#130f01;color:#b5471f;border:1px solid #ffd9c9;border-radius:999px;padding:.25rem .6rem;font-weight:600}

    /* ===== Timeline bonito ===== */
    .timeline-wrap{margin-top:10px}
    .day-group{margin:18px 0}
    .day-title{
      font-weight:800; color:#a2411a; letter-spacing:.04em; font-size:.9rem;
      display:inline-flex; align-items:center; gap:8px; margin-bottom:10px; text-transform:uppercase;
    }
    .day-title:before{
      content:""; width:10px; height:10px; border-radius:999px; background:var(--brand);
      box-shadow:0 0 0 4px #ffe8de;
    }
    .timeline{
      position:relative; padding-left:28px;
    }
    .timeline:before{
      content:""; position:absolute; left:14px; top:0; bottom:0; width:2px;
      background:linear-gradient(180deg,#ffd1bb,#ffe4d6); border-radius:2px;
    }
    .event{
      position:relative; margin:12px 0 12px 0; padding:14px 14px 12px 14px;
      background:#fff; border:1px solid #ffd3c1; border-left:4px solid var(--brand);
      border-radius:14px; box-shadow:0 6px 18px rgba(255,90,24,.08);
      transition:transform .15s ease, box-shadow .15s ease;
    }
    .event:hover{ transform:translateY(-1px); box-shadow:0 10px 24px rgba(255,90,24,.12); }
    .event .dot{
      position:absolute; left:-22px; top:16px; width:14px; height:14px; border-radius:50%;
      background:#fff; border:3px solid var(--brand);
    }
    .event-head{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px}
    .event-title{
      margin:0; font-weight:800; letter-spacing:.06em; color:#111; font-size:.95rem;
    }
    .badge-step{
      font-size:.72rem; font-weight:800; padding:.2rem .5rem; border-radius:999px;
      background:#fff6f1; border:1px solid #ffc2a8; color:#a2411a;
    }
    .event-meta{color:#6b7280; font-size:.82rem; display:flex; align-items:center; gap:8px}
    .event-note{color:#374151; margin-top:4px}
  </style>
</head>
<body>

  <!-- Topbar -->
  <div class="container-fluid topbar text-white py-2 px-lg-5">
    <div class="d-flex justify-content-between small">
      <div><i class="fa fa-phone-alt mr-2"></i> +57 320 456 7890 <span class="px-2">|</span> <i class="fa fa-envelope mr-2"></i> logicoders@gmail.com</div>
      <div class="d-none d-md-block">
        <a class="text-white px-2" href="#"><i class="fab fa-facebook-f"></i></a>
        <a class="text-white px-2" href="#"><i class="fab fa-twitter"></i></a>
        <a class="text-white px-2" href="#"><i class="fab fa-linkedin-in"></i></a>
        <a class="text-white px-2" href="#"><i class="fab fa-instagram"></i></a>
      </div>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-light navbar-light py-3 px-lg-5">
    <a href="index.html" class="navbar-brand">
      <h1 class="m-0 text-uppercase text-primary"><i class="fa fa-truck mr-2"></i>LogiCoders</h1>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div id="navbarCollapse" class="collapse navbar-collapse justify-content-between px-lg-3">
      <div class="navbar-nav m-auto">
        <a href="index.html" class="nav-item nav-link">Inicio</a>
        <a href="about.html" class="nav-item nav-link">Nosotros</a>
        <a href="service.html" class="nav-item nav-link">Servicios</a>
        <div class="nav-item dropdown">
          <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Consultas</a>
          <div class="dropdown-menu">
            <a href="estadoEnvio.html" class="dropdown-item active">Estado del Envío</a>
          </div>
        </div>
        <a href="contact.html" class="nav-item nav-link">Contáctanos</a>
      </div>
      <a href="login.html" class="btn btn-brand text-white px-4 d-none d-lg-block">Acceso</a>
    </div>
  </nav>

  <!-- Hero -->
  <section class="track-hero">
    <div class="container text-center">
      <h1 class="display-5 font-weight-bold mb-2">Estado del envío</h1>
      <p class="lead mb-4">Consulta tu guía y mira el avance en tiempo real.</p>

      <!-- Buscador -->
      <div class="track-box">
        <form id="form-track" class="input-group input-group-lg">
          <div class="input-group-prepend">
            <span class="input-group-text bg-white border-0"><i class="fa fa-barcode text-primary"></i></span>
          </div>
          <input id="track-input" class="form-control border-0" placeholder="Ej: LGC-2025-000123" required>
          <div class="input-group-append">
            <button class="btn btn-brand text-white px-4" type="submit"><i class="fa fa-search mr-1"></i> Rastrear</button>
          </div>
        </form>
        <div class="chips mt-3"></div>
      </div>

      <div id="track-result" class="mt-4 text-left"></div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-dark text-white mt-5 py-4 px-3">
    <div class="row">
      <div class="col-md-6"><p class="mb-0">&copy; 2025 LogiCoders. Todos los derechos reservados.</p></div>
    </div>
  </footer>

  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>

  <script>
    const API = "/api";

    /* ==== Helpers de verificación ==== */
    const maskEmail = v => {
      if(!v || !String(v).includes('@')) return null;
      const [u,d]=String(v).split('@');
      const uMask = u[0]+'*'.repeat(Math.max(0,u.length-2))+u.slice(-1);
      const dMask = d.replace(/([^.])[^.]+/g,'$1'+'*'.repeat(6));
      return `${uMask}@${dMask}`;
    };
    const maskPhoneTight = v => {
      if(!v) return null;
      const s = String(v).replace(/\D/g,'');
      const first = s[0] ?? '';
      const last4 = s.slice(-4);
      return `${first}${'*'.repeat(Math.max(0,s.length-1-4))}${last4}`;
    };
    const fakePhonesLike = (real, qty=3) => {
      const s = String(real).replace(/\D/g,'');
      const len = s.length; const first = s[0] || '3';
      const set = new Set();
      while(set.size<qty){
        let cand = first;
        for(let i=1;i<len;i++) cand += Math.floor(Math.random()*10);
        if(cand!==s) set.add(cand);
      }
      return [...set];
    };
    const shuffle = arr => arr.sort(()=>Math.random()-0.5);

    /* ==== Chips de ejemplo ==== */
    async function cargarChips() {
      try {
        const res = await fetch(`${API}/track/ejemplos`);
        const data = await res.json();
        document.querySelector(".chips").innerHTML = data.map(code =>
          `<span class="chip" data-code="${code}"><i class="fa fa-hashtag"></i>${code}</span>`).join("");
      } catch {}
    }
    document.addEventListener("click", e => {
      const chip = e.target.closest(".chip");
      if (chip) document.getElementById("track-input").value = chip.dataset.code;
    });

    /* ===== Helpers de fecha para timeline ===== */
    function fmtDateTime(val){
      if(!val) return "-";
      const d = new Date(val);
      if (isNaN(d.getTime())) return String(val);
      return d.toLocaleString('es-CO',{ dateStyle:'medium', timeStyle:'short' });
    }
    function ymd(val){
      const d = new Date(val);
      if (isNaN(d.getTime())) return "Otros";
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }

    /* ===== Render del HISTORIAL estilizado ===== */
    function renderHistorial(container, timeline, creadoEn, origen, destino){
      const data = Array.isArray(timeline) && timeline.length ? timeline : [
        { step:"CREADA", at: creadoEn, note:`Solicitud registrada (${origen} → ${destino})` }
      ];

      // agrupar por día
      const groups = data.reduce((acc, ev)=>{
        const key = ymd(ev.at || Date.now());
        (acc[key] ||= []).push(ev);
        return acc;
      }, {});
      const orderedDays = Object.keys(groups).sort((a,b)=> a>b ? -1 : 1); // más reciente primero

      const html = `
        <div class="timeline-wrap">
          ${orderedDays.map(day=>{
            const items = groups[day].sort((a,b)=> new Date(b.at) - new Date(a.at));
            const dayLabel = new Date(day).toLocaleDateString('es-CO',{weekday:'long', year:'numeric', month:'long', day:'numeric'});
            return `
              <div class="day-group">
                <div class="day-title">${dayLabel}</div>
                <div class="timeline">
                  ${items.map(ev=>`
                    <div class="event">
                      <div class="dot"></div>
                      <div class="event-head">
                        <h6 class="event-title">${(ev.step||'-').toString().replace(/_/g,' ')}</h6>
                        <span class="badge-step">${fmtDateTime(ev.at)}</span>
                      </div>
                      <div class="event-meta">
                        <i class="fa fa-clock"></i> ${fmtDateTime(ev.at)}
                      </div>
                      ${ev.note ? `<div class="event-note">${ev.note}</div>` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;

      container.querySelector('#panel-historial').innerHTML = `
        <div class="divider"></div>
        ${html}
      `;
    }

    /* ==== Pantalla de verificación (tel/email) ==== */
    function renderVerify(data, onSuccess){
      const dest = data.destinatario || {};
      const phone = dest.tel || dest.telefono || dest.phone;
      const div = document.getElementById("track-result");

      if (phone){
        const real = String(phone).replace(/\D/g,'');
        const fakes = fakePhonesLike(real,3);
        const options = shuffle([{value:real,real:true}, ...fakes.map(v=>({value:v,real:false}))]);

        div.innerHTML = `
          <div class="verify-card">
            <h5 class="verify-title mb-3">Selecciona el número telefónico del destinatario y escríbelo completo en el campo de abajo</h5>
            <div class="verify-list d-flex justify-content-center flex-wrap">
              ${options.map((o,i)=>`<label><input type="radio" name="verifyPhone" value="${i}"> <span class="verify-mask">${maskPhoneTight(o.value)}</span></label>`).join("")}
            </div>
            <div class="verify-input">
              <input id="verify-input" class="form-control form-control-lg" placeholder="Digite el número completo.">
            </div>
            <div class="text-center mt-2"><button id="verify-continue" class="btn btn-brand btn-lg px-4">CONTINUAR</button></div>
          </div>`;

        document.getElementById("verify-continue").onclick = ()=>{
          const sel = document.querySelector('input[name="verifyPhone"]:checked');
          const typed = document.getElementById("verify-input").value.replace(/\D/g,'');
          if(!sel) return alert("Selecciona una opción.");
          if(!typed) return alert("Digita el número completo.");
          const choice = options[+sel.value];
          if(!choice.real) return alert("Esa opción no es la correcta.");
          if(typed===real) return onSuccess();
          alert("El número no coincide.");
        };
        return;
      }

      if (dest.email){
        const masked = maskEmail(dest.email);
        div.innerHTML = `
          <div class="verify-card">
            <h5 class="verify-title mb-3">Escribe el correo completo del destinatario</h5>
            <p><small>Pista: ${masked}</small></p>
            <div class="verify-input"><input id="verify-input" class="form-control form-control-lg" placeholder="usuario@dominio.com"></div>
            <div class="text-center mt-2"><button id="verify-continue" class="btn btn-brand btn-lg px-4">CONTINUAR</button></div>
          </div>`;
        document.getElementById("verify-continue").onclick=()=>{
          const val=document.getElementById("verify-input").value.trim().toLowerCase();
          if(val && val===String(dest.email).toLowerCase()) return onSuccess();
          alert("El correo no coincide.");
        };
        return;
      }
      onSuccess();
    }

    /* ==== Render del resultado (Detalle / Historial) ==== */
    function renderResultado(data){
      const container=document.getElementById("track-result");

      const steps = ["CREADO","RECIBIDO","EN RUTA","ENTREGADO"];
      const raw = (data.estado || data.status || data.step || "").toString().trim().toUpperCase();
      const norm = raw.replace(/_/g," ");
      let current = steps.indexOf(norm);
      if(current < 0) current = 0;

      const fillPct = (current/(steps.length-1))*100;
      const precioFmt = (v => Number(v||0).toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0}))(data.precioCOP);

      container.innerHTML=`
        <div class="result-card">
          <div class="d-flex justify-content-between align-items-start">
            <div class="result-header">
              <div class="state-icon"><i class="fa fa-truck"></i></div>
              <div>
                <h3>${steps[current]}</h3>
                <div class="guide-num">Número de la guía: <strong>${data.guia}</strong></div>
              </div>
            </div>
          </div>

          <!-- Stepper -->
          <div class="progress-track">
            <div class="progress-line"></div>
            <div class="progress-fill" style="--fill:${fillPct}%"></div>
            <div class="progress-steps">
              ${steps.map((_,i)=>`<div class="progress-node ${i<=current?'active':''}">${i+1}</div>`).join("")}
            </div>
            <div class="progress-labels">
              ${steps.map(s=>`<span>${s}</span>`).join("")}
            </div>
          </div>

          <!-- Tabs -->
          <div class="tabs">
            <button class="tab-btn active" data-tab="detalle">DETALLE</button>
            <button class="tab-btn" data-tab="historial">HISTORIAL</button>
          </div>

          <!-- Panel: Detalle -->
          <div id="panel-detalle" class="panel active">
            <div class="divider"></div>
            <h6 class="section-title">Resumen del envío</h6>
            <div class="row">
              <div class="col-md-6">
                <div class="kv"><span class="k">Origen:</span><span class="v">${data.origen}</span></div>
                <div class="kv"><span class="k">Destino:</span><span class="v">${data.destino}</span></div>
                <div class="kv"><span class="k">Producto:</span><span class="v">${data.producto || '-'}</span></div>
                <div class="kv"><span class="k">Tiempo de entrega:</span><span class="v">${data.tiempo || '-'}</span></div>
              </div>
              <div class="col-md-6">
                <div class="kv"><span class="k">Método de pago:</span><span class="v">${data.metodoPago || '-'}</span></div>
                <div class="kv"><span class="k">Precio estimado:</span><span class="v">${precioFmt}</span></div>
                <div class="kv"><span class="k">Distancia aprox.:</span><span class="v">${(data.distanciaKm??'-')} km</span></div>
                <div class="kv"><span class="k">Creado en:</span><span class="v">${data.creadoEn || '-'}</span></div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="row">
              <div class="col-md-6">
                <h6 class="section-title">Remitente</h6>
                <div class="kv"><span class="k">Nombre:</span><span class="v">${data.remitente?.nombre || '-'}</span></div>
                <div class="kv"><span class="k">Documento:</span><span class="v">${data.remitente?.doc || '-'}</span></div>
                <div class="kv"><span class="k">Teléfono:</span><span class="v">${data.remitente?.tel || '-'}</span></div>
                <div class="kv"><span class="k">Email:</span><span class="v">${data.remitente?.email || '-'}</span></div>
                <div class="kv"><span class="k">Dirección:</span><span class="v">${data.remitente?.direccion || '-'}</span></div>
                <div class="kv"><span class="k">Ciudad:</span><span class="v">${data.remitente?.ciudad || '-'}</span></div>
              </div>
              <div class="col-md-6">
                <h6 class="section-title">Destinatario</h6>
                <div class="kv"><span class="k">Nombre:</span><span class="v">${data.destinatario?.nombre || '-'}</span></div>
                <div class="kv"><span class="k">Documento:</span><span class="v">${data.destinatario?.doc || '-'}</span></div>
                <div class="kv"><span class="k">Teléfono:</span><span class="v">${data.destinatario?.tel || data.destinatario?.telefono || '-'}</span></div>
                <div class="kv"><span class="k">Dirección:</span><span class="v">${data.destinatario?.direccion || '-'}</span></div>
                <div class="kv"><span class="k">Ciudad:</span><span class="v">${data.destinatario?.ciudad || '-'}</span></div>
              </div>
            </div>
          </div>

          <!-- Panel: Historial -->
          <div id="panel-historial" class="panel"></div>
        </div>
      `;

      // Tabs interactividad
      container.querySelectorAll('.tab-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          container.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const tab = btn.dataset.tab;
          container.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
          container.querySelector(`#panel-${tab}`).classList.add('active');
        });
      });

      // 👉 pinta el historial con estilo
      renderHistorial(container, data.timeline, data.creadoEn, data.origen, data.destino);
    }

    /* ==== Submit ==== */
    document.getElementById("form-track").addEventListener("submit", async e=>{
      e.preventDefault();
      const guia=document.getElementById("track-input").value.trim();
      const res=await fetch(`${API}/track/${encodeURIComponent(guia)}`);
      if(!res.ok){alert("No encontrada");return;}
      const data=await res.json();
      renderVerify(data, ()=>renderResultado(data));
    });

    cargarChips();
  </script>
</body>
</html>
